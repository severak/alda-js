<!doctype html>
<html>
<head>
<title>Alda web workspace</title>
    <style>
    .main {
        max-width: 50em;
        margin: 1em auto;
        font-family: sans-serif;
    }

    a {
        color: blue;
        text-decoration: none;
    }

    a:hover {
        text-decoration: underline;
    }

    #clear {
        float: right;
    }

    textarea {
        width: 100%;
    }

    .error {
        color: red;
    }
    </style>
</head>
<body>
<!-- this is from https://github.com/colinbdclark/osc.js : -->
<script src="js/osc.js"></script>
<script src="js/JZZ.js"></script>
<script src="js/JZZ.midi.SMF.js"></script>
<script src="js/JZZ.synth.Tiny.js"></script>
<script src="js/JZZ.gui.Select.js"></script>
<script>
// (c) Severák 2021-2022
// MIT licensed
var AldaPlayer = {};

AldaPlayer.output = JZZ().openMidiOut().or('not opening');

// this takes Open Sound Control bundle generated by ALDA programming language
// converts it to MIDI
AldaPlayer.osc2midi = function (bundle, ignoreProgramChanges=false) {
    let view = osc.dataView(bundle, 0, bundle.byteLength || bundle.length);
    let data = osc.readBundle(view, {});

    let BPM = 0;

    for (let command of data.packets) {
        if (command.address && command.address=='/system/tempo') {
            BPM = command.args[1];
        }
    }

    let midiFile = JZZ.MIDI.SMF();
    let trak0 = JZZ.MIDI.SMF.MTrk();
    midiFile.push(trak0);
    trak0.smfBPM(BPM);

    // pulse per milisecond
    let PPMS = ((BPM * 96) / 60) / 1000;

    let commandPattern = /\/track\/(\d+)\/midi\/(\w+)/;

    let trakAdd = function (midiFile) {
        let trak = JZZ.MIDI.SMF.MTrk();
        midiFile.push(trak);
        return trak;
    };

    let isPercCh = {};

    for (let packet of data.packets) {
        let fullCmd, ch, command;
        if (commandPattern.test(packet.address)) {
            [fullCmd, ch, command] = commandPattern.exec(packet.address);

            if (isPercCh[ch]) ch = 9; // MIDI percussion channel is always 10

            let offset = packet.args[0];
            let tik = PPMS * offset;
            let trak = midiFile[ch] || trakAdd(midiFile);

            if (command == 'note') {
                trak.add(tik, JZZ.MIDI.noteOn(ch, packet.args[1], packet.args[4]));
                trak.add(tik + (packet.args[2] * PPMS), JZZ.MIDI.noteOff(ch, packet.args[1], packet.args[4]))
                if (packet.args[2]==0) {
                    console.log('pauze');
                }
            } else if (command == 'patch') {
                if (!ignoreProgramChanges) {
                    // program change
                    trak.add(tik, JZZ.MIDI.program(ch, packet.args[1]));
                    trak.add(tik, JZZ.MIDI.smfInstrName('MIDI program #' + packet.args[1]));
                }
            } else if (command == 'volume') {
                //console.log('VOL', ch, packet.args[1]/127);
                trak.add(tik, JZZ.MIDI.volumeMSB(ch, packet.args[1]));
            } else if (command == 'percussion') {
                // we can only play percussion on one channel
                isPercCh[ch] = true;
                console.log(isPercCh);
            }
            // TODO - panning
            console.log(command, ch, packet.args);
        }

        if (packet.address=='/system/shutdown') {
            for (let trk of midiFile) {
                trk.add(packet.args[0] * PPMS, JZZ.MIDI.smfEndOfTrack());
            }
        }
    }

    return midiFile;
};

AldaPlayer.playMIDI = function(midiFile) {

    if (AldaPlayer.player) {
        console.log('Already playing!');
        return;
    }

    let player = midiFile.player();

    player.onEnd = function () {
        console.log('END!');
        // document.getElementById('errormsg').innerText = '(song ended successfully)';
        enablePlayButton();
        AldaPlayer.player = null;
    };

    player.connect(AldaPlayer.output);
    player.play();

    AldaPlayer.player = player;
    return player;
};

AldaPlayer.stop = function()
{
    if (AldaPlayer.player) {
        AldaPlayer.player.stop();
    }
    AldaPlayer.player = null;
};

AldaPlayer.downloadMIDI = function(midiFile, name) {
    var buffer = midiFile.toArrayBuffer();
    var blob = new File([buffer], name + '.mid', {type: "audio/midi"});
    var objectUrl = URL.createObjectURL(blob);
    window.open(objectUrl);
};

window.AldaPlayer = AldaPlayer;
</script>

<!-- this part is WASM loader -->
<script src="js/wasm_exec.js"></script>
<script>
if (!WebAssembly.instantiateStreaming) { // polyfill
    WebAssembly.instantiateStreaming = async (resp, importObject) => {
        const source = await (await resp).arrayBuffer();
        return await WebAssembly.instantiate(source, importObject);
    };
}

const go = new Go();
WebAssembly.instantiateStreaming(
    fetch("js/alda.wasm"), go.importObject
).then((result) => {
    go.run(result.instance)
    console.info(`alda.wasm ${Alda.VERSION} loaded`)
}).catch((err) => {
    console.error(err);
});
</script>

<!-- this part is UI -->
<div class="main">
    <h1><a href="https://alda.io/"><img src="alda-logo-horizontal.svg" alt="Alda"></a></h1>
    <p>musical programming language web workspace <button id="clear">clear workspace</button></p>
    <textarea placeholder="write your alda score here..." rows="25" cols="80" id="score">
# Stone in focus
# (that song from video with chilling monkey)
# by Aphex Twin

# as this is ambient piece is has very simple structure
# but what really makes it is used sound
# for me - violin works best

(tempo! 20)
(quant! 85)

motif = [
	V2: o4 c+ <d f+/b r
	V1: o3 a >d <g r
                   ]

midi-violin:
   (ppp) motif
   (pp) motif
   (p) motif
   (mp) motif *4 # <- there you can make it longer
   (p) motif
   (pp) motif
   (ppp) motif
    </textarea>
    <br/>
    <pre id="errormsg" class="error"></pre>

    <p>
        MIDI OUT: <select id="midiout"></select>
        <span id="player_buttons" style="display: none">
            <button id="play">PLAY</button>
            <button id="stop">STOP</button>
            (<label><input type="checkbox" id="one_program"> don't send program changes</label>)
        </span>
        <span id="player_warning">
            (You need to select MIDI OUT first to be able to play it.)
        </span>
    </p>
    <p>
        <button id="download">DOWNLOAD MIDI</button>
    </p>

    <p>Tested in recent versions of Chrome and Firefox. In Firefox you need <a href="https://jazz-soft.net/download/">Jazz Plugin</a> installed.</p>
    <p>Head out to <a href="https://alda.io/tutorial/">Alda tutorial</a>, <a href="https://github.com/alda-lang/alda/tree/master/examples">examples in Alda repository</a> or <a href="https://github.com/severak/sheet-music">my sheet-music repo</a> for more score examples.</p>
    <p>See <a href="https://alda.io/tutorial">tutorial</a> and <a href="https://alda.io/cheat-sheet">cheat sheet</a> for more info about Alda syntax.</p>
    <hr>
    <p>Made by Dave Yarwood, Severák and many giants on whose shoulders we are standing. See <a href="https://github.com/severak/alda-js">source code</a>.</p>

</div>
<script>
navigator.requestMIDIAccess().then(function (access) {
    console.log('povoleno midi out');
});

JZZ.synth.Tiny.register();
var midiOut = JZZ.gui.SelectMidiOut({at: 'midiout'});

midiOut.onSelect = function(name) {
    JZZ().openMidiOut(name).and(function () {
        AldaPlayer.output = this;
        document.getElementById('player_buttons').style.display = 'inline';
        document.getElementById('player_warning').style.display = 'none';
    }).or(function () {
        console.log('unselect MIDI OUT');
        document.getElementById('player_buttons').style.display = 'none';
        document.getElementById('player_warning').style.display = 'inline';
    });
};

function disablePlayButton() {
    document.getElementById('play').setAttribute('disabled', 'disabled');
}

function enablePlayButton() {
    document.getElementById('play').removeAttribute('disabled');
}

document.getElementById('clear').addEventListener('click', function (event) {
    event.preventDefault();
    document.getElementById('score').value = '';
});

document.getElementById('play').addEventListener('click', function (event) {
   event.preventDefault();
    Alda.toOSCBytes(document.getElementById('score').value).then(function (osdData) {
        var midi = AldaPlayer.osc2midi(osdData, document.getElementById('one_program').checked);
        try {
            disablePlayButton();
            AldaPlayer.playMIDI(midi);
            document.getElementById('errormsg').innerText = '';
        } catch (e) {
            document.getElementById('errormsg').innerText = e;
        }
    }, function (errorMsg) {
        document.getElementById('errormsg').innerText = errorMsg;
    })
});

document.getElementById('stop').addEventListener('click', function (event) {
    event.preventDefault();
    AldaPlayer.stop();
    for (let ch = 0; ch < 16; ch++) {
        AldaPlayer.output.allNotesOff(ch);
    }
    enablePlayButton();
});

document.getElementById('download').addEventListener('click', function (event) {
    event.preventDefault();
    Alda.toOSCBytes(document.getElementById('score').value).then(function (osdData) {
        var midi = AldaPlayer.osc2midi(osdData);
        try {
            AldaPlayer.downloadMIDI(midi, '');
            document.getElementById('errormsg').innerText = '';
        } catch (e) {
            document.getElementById('errormsg').innerText = e;
        }
    }, function (errorMsg) {
        document.getElementById('errormsg').innerText = errorMsg;
    })
});
</script>

</body>
</html>
