<!doctype html>
<html>
<head>
<title>OSC player test</title>
</head>
<body>
<!-- this is from https://github.com/colinbdclark/osc.js : -->
<script src="js/osc.js"></script>
<script src="js/JZZ.js"></script>
<script src="js/JZZ.midi.SMF.js"></script>
<script>
// (c) Sever√°k 2021
// MIT licensed
var AldaPlayer = {};

// this takes Open Sound Control bundle generated by ALDA programming language
// converts it to MIDI
AldaPlayer.osc2midi = function (bundle) {
    let view = osc.dataView(bundle, 0, bundle.byteLength || bundle.length);
    let data = osc.readBundle(view, {});

    let BPM = 0;

    for (let command of data.packets) {
        if (command.address && command.address=='/system/tempo') {
            BPM = command.args[1];
        }
    }

    let midiFile = JZZ.MIDI.SMF();
    let trak0 = JZZ.MIDI.SMF.MTrk();
    midiFile.push(trak0);
    trak0.smfBPM(BPM);

    // pulse per milisecond
    let PPMS = ((BPM * 96) / 60) / 1000;

    let commandPattern = /\/track\/(\d+)\/midi\/(\w+)/;

    let trakAdd = function (midiFile) {
        let trak = JZZ.MIDI.SMF.MTrk();
        midiFile.push(trak);
        return trak;
    };

    let isPercCh = {};

    for (let packet of data.packets) {
        let fullCmd, ch, command;
        if (commandPattern.test(packet.address)) {
            [fullCmd, ch, command] = commandPattern.exec(packet.address);

            if (isPercCh[ch]) ch = 9; // MIDI percussion channel is always 10

            let offset = packet.args[0];
            let tik = PPMS * offset;
            let trak = midiFile[ch] || trakAdd(midiFile);

            if (command == 'note') {
                trak.add(tik, JZZ.MIDI.noteOn(ch, packet.args[1], packet.args[4]));
                trak.add(tik + (packet.args[2] * PPMS), JZZ.MIDI.noteOff(ch, packet.args[1], packet.args[4]))
                if (packet.args[2]==0) {
                    console.log('pauze');
                }
            } else if (command == 'patch') {
                // program change
                trak.add(tik, JZZ.MIDI.program(ch, packet.args[1]));
                trak.add(tik, JZZ.MIDI.smfInstrName('MIDI program #' + packet.args[1]));
            } else if (command == 'volume') {
                //console.log('VOL', ch, packet.args[1]/127);
                trak.add(tik, JZZ.MIDI.volumeMSB(ch, packet.args[1]));
            } else if (command == 'percussion') {
                // we can only play percussion on one channel
                isPercCh[ch] = true;
                console.log(isPercCh);
            }
            // TODO - panning
            console.log(command, ch, packet.args);
        }

        if (packet.address=='/system/shutdown') {
            for (let trk of midiFile) {
                trk.add(packet.args[0] * PPMS, JZZ.MIDI.smfEndOfTrack());
            }
        }
    }

    return midiFile;
};

AldaPlayer.playMIDI = function(midiFile) {

    if (AldaPlayer.player) {
        console.log('Already playing!');
        return;
    }

    let player = midiFile.player();
    let out = JZZ().openMidiOut().or('not opening');

    player.onEnd = function () {
        console.log('END!');
        AldaPlayer.player = null;
    };

    player.connect(out);
    player.play();

    AldaPlayer.player = player;
    return player;
};

AldaPlayer.stop = function()
{
    if (AldaPlayer.player) {
        AldaPlayer.player.stop();
    }
    AldaPlayer.player = null;
};

AldaPlayer.downloadMIDI = function(midiFile, name) {
    var buffer = midiFile.toArrayBuffer();
    var blob = new File([buffer], name + '.mid', {type: "audio/midi"});
    var objectUrl = URL.createObjectURL(blob);
    window.open(objectUrl);
};

window.AldaPlayer = AldaPlayer;
</script>
<script>


function play(fname) {
    fetch(fname)
        .then(response => response.arrayBuffer())
        .then(blob => {
            AldaPlayer.playMIDI(AldaPlayer.osc2midi(blob));
        })
}

function stop() {
    AldaPlayer.stop();
}

function download(fname) {
    fetch(fname)
        .then(response => response.arrayBuffer())
        .then(blob => {
            AldaPlayer.downloadMIDI(AldaPlayer.osc2midi(blob), fname);
        })
}
</script>
<pre id="data"></pre>


<button onclick="play('bladerunner.data')">Play Blade Runner</button><br>
<button onclick="play('gau.data')">Play Gau's Theme</button><br>
<button onclick="play('bach.data')">Play Prelude, Cello Suite No. 1 in G Major (BMV 1007)</button><br>
<button onclick="play('debussy.data')">Play String Quartet in G Minor, Claude Debussy</button><br>
<button onclick="play('perc.data')">Play percussion test</button><br>
<br>
<button onclick="stop()">Stop!</button>
<br>
<br>
<button onclick="download('bladerunner.data')">Download Blade Runner</button><br>
<button onclick="download('gau.data')">Download Gau's Theme</button><br>
<button onclick="download('bach.data')">Download Prelude, Cello Suite No. 1 in G Major (BMV 1007)</button><br>
<button onclick="download('debussy.data')">Download String Quartet in G Minor, Claude Debussy</button><br>
<button onclick="download('perc.data')">Download percussion test</button><br>
</body>
</html>
